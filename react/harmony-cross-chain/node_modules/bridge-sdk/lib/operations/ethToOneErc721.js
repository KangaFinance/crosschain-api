"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.ethToOneErc721 = void 0;
const interfaces_1 = require("../interfaces");
const logs_1 = require("../utils/logs");
const operation_helpers_1 = require("../operation-helpers");
const utils_1 = require("../utils");
exports.ethToOneErc721 = async (api, operationParams, ethMethods, hmyMethods, prefix, maxWaitingTime) => {
    let operation = await api.getOperation(operationParams.id);
    let getHRC20Action = operation_helpers_1.getActionByType(operation, interfaces_1.ACTION_TYPE.getHRC20Address);
    if (getHRC20Action) {
        logs_1.logger.wait({ prefix, message: 'getHRC20Address' });
    }
    while (getHRC20Action && [interfaces_1.STATUS.IN_PROGRESS, interfaces_1.STATUS.WAITING].includes(getHRC20Action.status)) {
        await utils_1.sleep(3000);
        operation = await api.getOperation(operationParams.id);
        getHRC20Action = operation_helpers_1.getActionByType(operation, interfaces_1.ACTION_TYPE.getHRC20Address);
    }
    const approveEthManger = operation_helpers_1.getActionByType(operation, interfaces_1.ACTION_TYPE.approveEthManger);
    if (approveEthManger && approveEthManger.status === interfaces_1.STATUS.WAITING) {
        logs_1.logger.pending({ prefix, message: 'approveHmyManger' });
        const { erc20Address } = operationParams;
        await ethMethods.setApprovalForAllEthManger(erc20Address, (hash) => operation_helpers_1.confirmCallback(api, hash, approveEthManger.type, operationParams.id));
        logs_1.logger.success({ prefix, message: 'approveHmyManger' });
    }
    operation = await api.getOperation(operationParams.id);
    const lockToken = operation_helpers_1.getActionByType(operation, interfaces_1.ACTION_TYPE.lockToken);
    if (lockToken && lockToken.status === interfaces_1.STATUS.WAITING) {
        logs_1.logger.pending({ prefix, message: 'lockToken' });
        const res = await ethMethods.lockTokens(operationParams.erc20Address, operationParams.oneAddress, operationParams.amount, (hash) => operation_helpers_1.confirmCallback(api, hash, lockToken.type, operationParams.id));
        logs_1.logger.info({ prefix, message: 'Status: ' + res.status });
        logs_1.logger.success({ prefix, message: 'lockToken' });
    }
    const waitingBlockNumber = await operation_helpers_1.waitAction(api, operationParams.id, interfaces_1.ACTION_TYPE.waitingBlockNumber, maxWaitingTime, prefix);
    if (!operation_helpers_1.checkStatus(waitingBlockNumber, prefix, interfaces_1.ACTION_TYPE.waitingBlockNumber)) {
        return false;
    }
    const mintToken = await operation_helpers_1.waitAction(api, operationParams.id, interfaces_1.ACTION_TYPE.mintToken, maxWaitingTime, prefix);
    if (!operation_helpers_1.checkStatus(mintToken, prefix, interfaces_1.ACTION_TYPE.mintToken)) {
        return false;
    }
    return true;
};
